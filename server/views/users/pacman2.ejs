<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset='utf-8'>
        <title>Pacman vs. Pacman</title>
        <link rel='stylesheet' href='/stylesheets/style2.css' />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    </head>
    <body>
        <div id='info'>
            <h1 class='yellow'>Pacman vs. Pacman</h1>
            <h2 class='time'> | Time: </h2>
            <h2 class='score'></h2>
        </div>
        <div id='container'></div>
        <div id='coins'></div>
        <div id='hero'></div>
        <div id='enemy'></div>
        <div id='end'></div>
    </body>
</html>
<script type="text/javascript">
    var socket = io.connect();
    var num = 0;
    var name = prompt('Welcome! Please enter your name.');
    socket.emit('login', { name: name });

    var game = new Game();
    var players = new Players();
    var player_array = [];
    var myID;
    
    var sound = {};
    // sound.start = new Audio('sounds/pacman_start.mp3');
    sound.eat = new Audio('sounds/pacman_chomp.wav');
    sound.power = new Audio('sounds/pacman_eatghost.wav')
    sound.die = new Audio('sounds/pacman_death.wav');
    sound.end = new Audio('sounds/pacman_intermission.wav')
    
    var upPac;
    
    socket.on('current_user', function (data) {
        players.createNew(data.name, data.info.x, data.info.y, data.info.pos, data.info.id);
        myID = data.info.id;
        game.drawMap();
        // game.drawCoins();
    })

    socket.on('all_users', function (data) {
        var count = 0;
        console.log(player_array);
        for (var id in data.users) {
            console.log('hello2')
            var user = data.users[id].info;
            players.createNew(user.name, user.x, user.y, user.pos, id);
            count++;
        }
        if (count === 1) {
            upPac = setInterval(mainLoop, 100);
        }
    })

    socket.on('new_user', function (data) {
        var count = 0;
        players.createNew(data.user.info.name, data.user.info.x, data.user.info.y, data.user.info.pos, data.user.info.id);
        for (var id in data.users) {
            count++;
        }
        if (count === 1) {
            console.log('2');
            upPac = setInterval(mainLoop, 100);
        }
    })

    socket.on('remove_user', function (remove_user) {
        document.getElementById(remove_user.id).remove();
    })

    document.onkeydown = function (e) {
        if (e.keyCode >= 37 && e.keyCode <= 40) {
            player_array[myID].info.pos_temp = e.keyCode;
            player_array[myID].update(player_array, game, myID, socket, sound);
        }
    }

    function mainLoop() {
        players.loop(player_array, game, myID, socket, sound);
        console.log(num);
    }




    function Game() {
        this.info = { tile: 10, conv: 3 };

        this.map = [
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,1,0,0,0,1,0,1,0,1,0,0,0,0,0,0,1,0,1,0,0,1,0,1,0,0,0,0,0,0,1,0,1,0,1,0,0,0,1,0],
            [0,1,0,1,1,1,0,1,0,1,0,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,1,1,0,1,0,1,0,1,1,1,0,1,0],
            [0,1,0,1,0,0,0,1,0,1,0,1,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,1,0,1,0,1,0,0,0,1,0,1,0],
            [0,1,0,1,1,1,1,1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,1,1,1,1,0,1,0],
            [0,1,0,0,1,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,1,0,0,1,0],
            [0,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,0],
            [0,1,1,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,1,1,0],
            [0,0,1,0,1,0,1,1,0,1,0,1,1,0,1,0,1,1,1,1,0,1,0,1,0,1,0,1,1,0,1,0,1,1,0,1,0,1,0,0],
            [1,1,1,1,1,0,1,0,0,1,0,1,0,0,1,0,1,1,1,1,0,1,0,1,0,1,0,1,0,0,1,0,1,1,0,1,1,1,1,1],
            [0,0,1,0,1,0,1,1,1,1,0,1,1,0,1,0,1,1,1,1,0,1,0,1,0,1,0,1,1,0,1,0,1,1,0,1,0,1,0,0],
            [0,1,1,0,1,0,1,1,1,1,0,1,1,0,1,0,0,0,0,1,0,1,0,1,0,1,0,1,1,0,1,0,1,1,0,1,0,1,1,0],
            [0,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,0],
            [0,1,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,1,0],
            [0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0],
            [0,1,0,1,0,0,0,1,0,1,0,1,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,1,0,1,0,1,0,0,0,1,0,1,0],
            [0,1,0,1,1,1,0,1,0,1,0,1,1,1,1,1,1,0,1,1,1,1,0,1,1,1,1,1,1,0,1,0,1,0,1,1,1,0,1,0],
            [0,1,0,0,0,1,0,1,0,1,0,0,0,0,0,0,1,0,1,0,0,1,0,1,0,0,0,0,0,0,1,0,1,0,1,0,0,0,1,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        ];

        this.coins = [];

        this.drawMap = function() {
            for (var i=0; i<this.map.length; i++){
                for (var j=0; j<this.map[i].length; j++){
                    if (this.map[i][j] == 1 || this.map[i][j] == 9){
                        $('#container').append("<div class='path'></div>");
                    }
                    else if (this.map[i][j] == 0){
                        $('#container').append("<div class='brick'></div>");
                    }
                }
            }
        }

        this.drawCoins = function() {
            for (var i=0; i<this.map.length; i++){
                for (var j=0; j<this.map[i].length; j++){
                    if (this.map[i][j] == 1){
                        var posY = i*30+42;
                        var posX = j*30+12;
                        var id = (posY-12).toString() + '-' + (posX-12).toString();
                        this.coins.push({id: id, x: posX, y: posY});
                    }
                }
            }
            for (var i in this.coins) {
                $('#coins').append("<img id='" + this.coins[i].id + "' class='coin'" +
                            "src='images/coin.jpg' style='top: " + this.coins[i].y + "px; left: " + this.coins[i].x + "px;'>");
            }

            $("img[id='300-210']").replaceWith("<img id='300-210' class='power'" +
                "src='images/powerpellet.gif' style='top: 300px; left: 210px;'>");
            $("img[id='300-360']").replaceWith("<img id='300-360' class='power'" +
                "src='images/powerpellet.gif' style='top: 300px; left: 360px;'>");
            $("img[id='300-630']").replaceWith("<img id='300-630' class='power'" +
                "src='images/powerpellet.gif' style='top: 300px; left: 630px;'>");
            $("img[id='300-690']").replaceWith("<img id='300-690' class='power'" +
                "src='images/powerpellet.gif' style='top: 300px; left: 690px;'>");
            $("img[id='300-840']").replaceWith("<img id='300-840' class='power'" +
                "src='images/powerpellet.gif' style='top: 300px; left: 840px;'>");                     
        }
    }



    function Pacman (name, x, y, pos, id) {
        this.info = { name: name, x: x, y: y, pos: pos, pos_temp: pos, id: id, collision: false, power: false, score: 0 };
        
        this.draw = function() {
            $('#hero').append("<div id='" + this.info.id + "'><img class='pacman' src='images/pacman" + this.info.pos +
                ".gif' style='top: " + this.info.y + "px; left: " + this.info.x + "px;'></div>");
        }

        this.update = function() {
            // This means that you are updating YOUR movement
            if (this.info.id == myID) {
                this.detectCollision(game);
                this.move(game);

                var el = document.getElementById(this.info.id);
                el.innerHTML = "<img class='pacman' src='images/pacman" + this.info.pos +
                  ".gif' style='top: " + this.info.y + "px; left: " + this.info.x + "px;'>";

                socket.emit('key_press', { info: this.info });
                // this.updateCoins(player_array, game, myID, socket, sound);
            }

            // This means you are updating another players movement
            else {
                var that = this;
                socket.on('new_movement', function (data) {
                    that.info = data.info;

                    var el = document.getElementById(data.info.id);
                    el.innerHTML = "<img class='pacman' src='images/pacman" + data.info.pos +
                        ".gif' style='top: " + data.info.y + "px; left: " + data.info.x + "px;'>";

                })

                // socket.on('update_coin', function (data) {
                //     $("#" + data.coin_id).remove();
                // })

                // socket.on('broadcast_score', function (data) {
                //     var score = '';
                //     score = player_array[myID].info.name + "'s Score: " + player_array[myID].info.score;
                //     player_array[data.id].info.score = data.score;
                //     for (var id in player_array) {
                //         if (player_array[id].info.id != player_array[myID].info.id) {
                //             score += " | " + player_array[id].info.name + "'s Score: " + player_array[id].info.score;
                //         }   
                //     }
                //     document.getElementById('info').children[2].innerHTML = score;
                // })

                // socket.on('game_over', function (data) {
                //     sound.end.play();
                //     clearInterval(upPac);
                //     clearInterval(mainTime);
                //     $('#end').append("<p id='loser'>You lose! " + data.name + " is the winner!</p>");
                // })
            }

            // socket.on('update_all_coins', function (data) {
            //     game.coins = data.coins;
            // })
        }

        this.detectCollision = function() {
            var block = game.info.tile * game.info.conv;
            this.info.collision = false;
            // Only checks for collision when Pacman is in center of block (no overlap)
            if (this.info.y % block === 0 && this.info.x % block === 0) {
                var x = this.info.x / block;
                var y = this.info.y / block;
                var left = game.map[y-1][Math.floor(x - 0.1)];
                var up = game.map[Math.floor(y - 0.1)-1][x];
                var right = game.map[y-1][Math.ceil(x + 0.1)];
                var down = game.map[Math.ceil(y + 0.1)-1][x];
                var options = [left, up, right, down];
                // This means user is trying to change directions
                if (this.info.pos !== this.info.pos_temp) {
                    // If next block is a path, it will change Pacman's position accordingly
                    if (options[this.info.pos_temp - 37] === 1 || options[this.info.pos_temp - 37] === 9) {
                        this.info.pos = this.info.pos_temp;
                    }
                }
                // Checks if next block is a wall or a tunnel
                if (options[this.info.pos - 37] === 0) {
                    this.info.collision = true;
                }
                else if (options[this.info.pos - 37] === undefined) {
                    this.info.collision = undefined;
                }
            }
        }

        this.move = function() {
            var block = game.info.tile * game.info.conv;
            var sign = [-1, -1, 1, 1];
            // Checks if next block is a tunnel
            if (this.info.collision === undefined) {
                if (this.info.pos === 37) {
                    this.info.x = game.map[0].length * block - block;
                }
                else if (this.info.pos === 39) {
                    this.info.x = 0;
                }
            }
            // Only moves Pacman if next block is a path
            else if (this.info.collision === false){
                if (this.info.pos === 37 || this.info.pos === 39) {
                    this.info.x += sign[this.info.pos - 37] * game.info.tile;
                }
                else if (this.info.pos === 38 || this.info.pos === 40) {
                    this.info.y += sign[this.info.pos - 37] * game.info.tile;
                }
            }
        }

        this.updateCoins = function() {

            // Used X-Y coordinates to create custom ID for each coin that links with X-Y position of Pacman.
            // This allows you to see if Pacman ate a coin without looping through the entire coin array.
            var coin_id;
            var el;
            var score='';
            for (var i=-1; i<2; i++) {
                for (var j=-1; j<2; j++) {
                    coin_id = (this.info.y + i * game.info.tile).toString() + '-' + (this.info.x + j * game.info.tile).toString();
                    if (document.getElementById(coin_id)) {
                        el = document.getElementById(coin_id);

                        if (coin_id == '300-210' || coin_id == '300-360' || coin_id == '300-630' || coin_id == '300-690' || coin_id == '300-840') {
                            sound.power.play();
                            this.info.score += 100;
                        }
                        else {
                            sound.eat.play();
                            this.info.score += 10;
                        }
                        
                        socket.emit('eat_coin', { coin_id: coin_id });
                        document.getElementById('coins').removeChild(el);
                        score = "Jeremy's Score: " + this.info.score;

                        for (var id in player_array) {
                            if (player_array[id].info.id != this.info.id) {
                                score += " | " + player_array[id].info.name + "'s Score: " + player_array[id].info.score;
                            }   
                        }
                        document.getElementById('info').children[2].innerHTML = score;
                        socket.emit('update_score', { id: this.info.id, score: this.info.score });
                        return;
                    }
                }
            }

            // if (game.coins.length == 0){
            //     $('#end').append("<p id='winner'>YOU WIN!!!</p>");
            //     var winner=0;
            //     var name;
            //     for (var id in player_array) {
            //         if (player_array[id].info.score > winner) {
            //             winner = player_array[id].info.score;
            //             name = player_array[id].info.name;
            //         }
            //     }
            //     sound.start.pause();
            //     sound.end.play();
            //     clearInterval(upPac);
            //     clearInterval(mainTime);
            //     $('#end').append("<p id='winner'>You are the winner!</p>");
            //     socket.emit('winner', { name: name });
            // }
        }

        this.draw();
    }

    function Players() {
        this.loop = function() {
            for (var id in player_array) {
                player_array[id].update();
            }
        }

        this.createNew= function (name, x, y, pos, id) {
            var pacman = new Pacman(name, x, y, pos, id);
            player_array[id] = pacman;
        }
    }

    function getDistance (x1, x2, y1, y2){
        return Math.sqrt((x1-x2)*(x1-x2) + (y1-y2)*(y1-y2));
    }
</script>
